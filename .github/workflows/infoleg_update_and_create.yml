name: Actualizar Infoleg y generar Digesto

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"   # corre todos los días a las 09:00 Argentina (UTC-3)

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest

    permissions:
      contents: write     # habilita git push si en algún momento lo necesitás

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          pip install pandas requests

      # ============================================================
      # 1) Descargar Infoleg (datos crudos → /data/)
      # ============================================================
      - name: Ejecutar descargar_infoleg.py
        env:
          DROPBOX_REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          DROPBOX_CLIENT_ID: ${{ secrets.APP_KEY }}
          DROPBOX_CLIENT_SECRET: ${{ secrets.APP_SECRET }}
        run: python scripts/descargar_infoleg.py

      # ============================================================
      # 2) Procesar Infoleg (→ genera /data_procesada/)
      # ============================================================
      - name: Ejecutar procesar_infoleg.py
        run: python scripts/procesar_infoleg.py

      # ============================================================
      # 3) Subir a Dropbox: data/ y data_procesada/
      # ============================================================

      - name: Subir archivos procesados a Dropbox
        env:
          DROPBOX_REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          DROPBOX_CLIENT_ID: ${{ secrets.APP_KEY }}
          DROPBOX_CLIENT_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          python - << 'EOF'
          import os, json, requests

          # ---------------------------------------------------------
          # Funciones utilitarias
          # ---------------------------------------------------------

          def obtener_access_token():
              data = {
                  "grant_type": "refresh_token",
                  "refresh_token": os.environ["DROPBOX_REFRESH_TOKEN"],
                  "client_id": os.environ["DROPBOX_CLIENT_ID"],
                  "client_secret": os.environ["DROPBOX_CLIENT_SECRET"]
              }
              r = requests.post("https://api.dropbox.com/oauth2/token", data=data)
              r.raise_for_status()
              return r.json()["access_token"]

          def subir_archivo(local_path, remote_path, token):
              with open(local_path, "rb") as f:
                  data = f.read()
              headers = {
                  "Authorization": f"Bearer {token}",
                  "Content-Type": "application/octet-stream",
                  "Dropbox-API-Arg": json.dumps({
                      "path": remote_path,
                      "mode": "overwrite",
                      "autorename": False,
                      "mute": False
                  })
              }
              r = requests.post("https://content.dropboxapi.com/2/files/upload",
                                headers=headers, data=data)
              print(f"{remote_path} → {r.status_code}")

          # ---------------------------------------------------------
          # Subir todos los archivos de data/ y data_procesada/
          # ---------------------------------------------------------

          token = obtener_access_token()

          carpetas = ["data", "data_procesada"]

          for carpeta in carpetas:
              local_dir = os.path.join(os.getcwd(), carpeta)
              if not os.path.exists(local_dir):
                  continue
              for archivo in os.listdir(local_dir):
                  ruta_local = os.path.join(local_dir, archivo)
                  ruta_remota = f"/{carpeta}/{archivo}"
                  subir_archivo(ruta_local, ruta_remota, token)

          EOF



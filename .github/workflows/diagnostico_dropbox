name: Diagnostico Dropbox

on:
  workflow_dispatch:

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: Crear script diagnóstico
        run: |
          cat << 'EOF' > diagnostico.py
          import requests, json, os

          APP_KEY = os.environ["APP_KEY"]
          APP_SECRET = os.environ["APP_SECRET"]
          REFRESH_TOKEN = os.environ["REFRESH_TOKEN"]

          def obtener_access_token():
              url = "https://api.dropbox.com/oauth2/token"
              data = {
                  "grant_type": "refresh_token",
                  "refresh_token": REFRESH_TOKEN,
                  "client_id": APP_KEY,
                  "client_secret": APP_SECRET
              }
              r = requests.post(url, data=data)
              r.raise_for_status()
              token = r.json()["access_token"]
              print("✔ Access token generado.\n")
              return token

          def listar(token, path):
              print(f"=== CONTENIDO DE: '{path or '(root)'}' ===")
              headers = {
                  "Authorization": f"Bearer {token}",
                  "Content-Type": "application/json"
              }
              r = requests.post(
                  "https://api.dropboxapi.com/2/files/list_folder",
                  headers=headers,
                  json={"path": path}
              )
              print(json.dumps(r.json(), indent=2, ensure_ascii=False))
              print("\n")

          if __name__ == "__main__":
              token = obtener_access_token()
              listar(token, "")
              listar(token, "/data")
              listar(token, "/data_procesada")
          EOF

      - name: Ejecutar diagnóstico
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        run: python3 diagnostico.py
